syntax = "proto3";

package viaems.console;

message Header {
  fixed32 seq = 1;
  fixed32 timestamp = 2;
}

enum SensorFault {
  NoFault = 0;
  RangeFault = 1;
  ConnectionFault = 2;
}

message Sensors {
  float ManifoldPressure = 2;
  float IntakeTemperature = 3;
  float CoolantTemperature = 4;
  float BatteryVoltage = 5;
  float ThrottlePosition = 6;
  float AmbientPressure = 7;
  float FuelRailTemperature = 8;
  float ExhaustGasOxygen = 9;
  float FuelRailPressure = 10;
  float EthanolContent = 11;

  float Knock1 = 12;
  float Knock2 = 13;
  
  SensorFault ManifoldPressure_Fault = 32;
  SensorFault IntakeTemperature_Fault = 33;
  SensorFault CoolantTemperature_Fault = 34;
  SensorFault BatteryVoltage_Fault = 35;
  SensorFault ThrottlePosition_Fault = 36;
  SensorFault AmbientPressure_Fault = 37;
  SensorFault FuelRailTemperature_Fault = 38;
  SensorFault ExhaustGasOxygen_Fault = 39;
  SensorFault FuelRailPressure_Fault = 40;
  SensorFault EthanolContent_Fault = 41;
}

enum DecoderState {
  NoSync = 0;
  RpmOnly = 1;
  Sync = 2;
}

enum DecoderLossReason {
  NoLoss = 0;
  ToothVariation = 1;
  TriggerCountTooHigh = 2;
  TriggerCountTooLow = 3;
  Expired = 4;
  Overflowed = 5;
}

message Position {
  fixed32 time = 1; 
  fixed32 valid_before_timestamp = 2; 

  DecoderState state = 3;
  DecoderLossReason state_cause = 4;

  float last_angle = 5;
  float instantaneous_rpm = 6;
  float average_rpm = 7;
}

message Calculations {
  float advance = 4;
  float dwell_us = 5;
  float fuel_us = 6;

  float airmass_per_cycle = 7;
  float fuelvol_per_cycle = 8;

  float tipin_percent = 9;
  float injector_dead_time = 10;
  float pulse_width_correction = 11;
  float lambda = 12;
  float ve = 13;
  float engine_temp_enrichment = 14;

  bool rpm_limit_cut = 15;
  bool boost_cut = 16;
  bool fuel_overduty_cut = 17;
  bool dwell_overduty_cut = 18;
}

message RawAdcUpdate {
  Header header = 1;
  bool valid = 2;
  repeated float values = 3;
}

message RawTriggerUpdate {
  Header header = 1;
  int32 trigger = 2;
}

message Event {
  Header header = 1;
  oneof type {
    uint32 Trigger = 4;
    uint32 OutputPins = 5;
    uint32 GpioPins = 6;
  }
}

message EngineUpdate {
  Header header = 1;
  Position position = 2;
  Sensors sensors = 3;
  optional Calculations calculations = 4;
}


message Configuration {
  message TableRow {
    repeated float values = 1;
  }

  message TableAxis {
    optional string name = 1;
    repeated float values = 2;
  }

  message Table1d {
    optional string name = 1;
    TableAxis cols = 2;
    TableRow data = 3;
  }

  message Table2d {
    optional string name = 1;
    TableAxis cols = 2;
    TableAxis rows = 3;
    repeated TableRow data = 4;
  }

  message Output {
    enum OutputType {
      OutputDisabled = 0;
      Fuel = 1;
      Ignition = 2;
    }

    optional uint32 pin = 1;
    optional OutputType type = 2;
    optional bool inverted = 3;
    optional float angle = 4;
  }

  enum SensorSource {
    None = 0;
    Adc = 1;
    Frequency = 2;
    Pulsewidth = 3;
    Const = 4;
  }

  enum SensorMethod {
    Linear = 0;
    LinearWindowed = 1;
    Thermistor = 2;
  }

  message Sensor {
    optional SensorSource source = 1;
    optional SensorMethod method = 2;

    optional uint32 pin = 3;
    optional float lag = 4;

    message LinearConfig {
      float output_min = 1;
      float output_max = 2;
      float input_min = 3;
      float input_max = 4;
    }

    message ConstConfig {
      float fixed_value = 1;
    }

    message ThermistorConfig {
      float A = 1;
      float B = 2;
      float C = 3;
      float bias = 4;
    }

    message FaultConfig {
      float min = 1;
      float max = 2;
      float value = 3;
    }

    message WindowConfig {
      float capture_width = 1 ;
      float total_width = 2;
      float offset = 3;
    }

    optional LinearConfig linear_config = 5;
    optional ConstConfig const_config = 6;
    optional ThermistorConfig thermistor_config = 7;

    optional FaultConfig fault_config = 8;
    optional WindowConfig window_config = 9;

  }

  message KnockSensor {
    optional bool enabled = 1;
    optional float frequency = 2;
    optional float threshold = 3;
  }

  message Sensors {
    Sensor AbsoluteAirPressure = 1;
    Sensor BatteryReferenceVoltage = 2;
    Sensor CoolantTemperature = 3;
    Sensor ExhaustGasOxygen = 4;
    Sensor FuelRailTemperature = 5;
    Sensor IntakeAirTemperature = 6;
    Sensor ManifoldPressure = 7;
    Sensor ThrottlePosition = 8;
    KnockSensor knock1 = 14;
    KnockSensor knock2 = 15;
  }

  enum TriggerType {
    DecoderDisabled = 0;
    EvenTeeth = 1;
    EvenTeethPlusCamSync = 2;
    MissingTooth = 3;
    MissingToothPlusCamSync = 4;
  }

  message Decoder {
    optional TriggerType trigger_type = 1;
    optional float degrees_per_trigger = 2;
    optional float max_tooth_variance = 3;
    optional float min_rpm = 4;
    optional uint32 num_triggers = 5;
    optional float offset = 6;
  }

  enum InputEdge {
    Rising = 0;
    Falling = 1;
    Both = 2;
  }

  enum InputType {
    InputDisabled = 0;
    Trigger = 1;
    Freq = 2;
  }

  message TriggerInput {
    optional InputEdge edge = 1;
    optional InputType type = 2;
  }

  message CrankEnrichment {
    optional float cranking_rpm = 1;
    optional float cranking_temp = 2;
    optional float enrich_amt = 3;
  }

  message Fueling {
    optional uint32 fuel_pump_pin = 1;
    optional float cylinder_cc = 2;
    optional float fuel_density = 3;
    optional float fuel_stoich_ratio = 4;
    optional uint32 injections_per_cycle = 5;
    optional float injector_cc = 6;
    optional float max_duty_cycle = 40;

    CrankEnrichment crank_enrich = 7;
    Table1d PulseWidthCompensation = 8;
    Table1d InjectorDeadTime = 9;
    Table2d EngineTempEnrichment = 10;
    Table1d CrankingEnrichment = 11;

    Table2d commanded_lambda = 12;
    Table2d ve = 13;

    Table2d tipin_enrich_amount = 14;
    Table1d tipin_enrich_duration = 15;

  }

  message Ignition {
    enum DwellType {
      FixedDwellTime = 0;
      BatteryVoltage = 1;
    }
    optional DwellType type = 1;
    optional float fixed_dwell = 2;

    Table1d dwell = 3;
    Table2d timing = 4;

  }

  message BoostControl {
    optional uint32 pin = 1;
    optional float control_threshold_map = 2;
    optional float control_threshold_tps = 3;
    optional float enable_threshold_map = 4;
    optional float overboost_map = 5;
    Table1d pwm_vs_rpm = 6;
  }

  message CheckEngineLight {
    optional uint32 pin = 1;
    optional float lean_boost_ego = 2;
    optional float lean_boost_map_enable = 3;
  }

  message RpmCut {
    optional float rpm_limit_start = 1;
    optional float rpm_limit_stop = 2;
  }

  message Debug {
    optional bool test_trigger_enabled = 1;
    optional float test_trigger_rpm = 2;
  }

  repeated Output outputs = 1;
  repeated TriggerInput triggers = 2;
  optional Sensors sensors = 3;
  optional Ignition ignition = 4;
  optional Fueling fueling = 5;
  optional Decoder decoder = 6;
  optional RpmCut rpm_cut = 7;
  optional CheckEngineLight cel = 8;
  optional BoostControl boost_control = 9;
  optional Debug debug = 10;
}


message Request {
  message Ping { }

  message SetConfig {
    Configuration config = 1;
  }

  message GetConfig { }

  message FlashConfig { }
  
  message ResetToBootloader { }

  message FirmwareInfo { }

  oneof type {
    Ping ping = 1;
    FirmwareInfo fwinfo = 2;

    SetConfig setconfig = 3;
    GetConfig getconfig = 4;
    FlashConfig flashconfig = 5;
    ResetToBootloader resettobootloader = 6;
  }
}

message Response {
  message Pong { }

  message SetConfig {
    Configuration config = 1;
    bool success = 2;
    bool requires_restart = 3;
  }
  message GetConfig {
    Configuration config = 1;
    bool needs_flash = 2;
  }
  message FlashConfig {
    bool success = 1;
  }

  message FirmwareInfo { 
    string version = 1;
    string platform = 2;
    string proto = 3;
  }

  oneof response {
    Pong pong = 1;
    FirmwareInfo fwinfo = 2;

    SetConfig setconfig = 3;
    GetConfig getconfig = 4;
    FlashConfig flashconfig = 5;
  }
}

message Message {
  oneof msg {
    EngineUpdate engine_update = 2;
    Event event = 3;
    Request request = 4;
    Response response = 5;
  }
}


